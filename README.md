# powerchute-vsphere-starwind-shutdown

## Introduction:
These scripts handle shutting down or consolidating a vSphere environment during a power loss event. The entire infrastructure can be shut down or VMs can be consolidated to a single host. You can also combine these scripts to run at the start of a power loss and when a longer-term power loss event occurs and your battery backups will die. These scripts are designed to be run by APC's PowerChute Network Server software against a 2-node vSphere cluster running StarWind's hyperconverged vSAN storage solution.


## Target/Required Infrastructure:
- 2-node vSphere cluster.
- StarWind HCA vSAN.
- APC UPS(s) with NMC(s) installed.
- APC PowerChute Network Server (PCNS).
- Network communication between the system PCNS runs on, the UPS(s), and the vSphere nodes.
- StarWind's powershell module installed on the independent system.


## powerchute-consolidate-vms
This script is designed as a first-step when a power failure occurs. It will consolidate all VMs to a single ESXi host and put the other ESXi host into maintance mode. The thought process is that (1) running all VMs off one host makes "locating" the VMs easier in a shutdown or power-restore scenario, (2) that you can shut down the vacated ESXi host to preserve battery runtime, and  (3) that there is a lesser chance of corruption if all VMs are running on a single StarWind storage VM.

The following steps occur:
- All powered-on VMs are vMotioned from ESXi2 to ESXi1.
- The StarWind storage VM on ESXi2 is shut down.
- ESXi2 is put into maintance mode.


## powerchute-vsphere-starwind-shutdown
This script is designed as a last-step when a power failure occurs and you want to shutdown all your VMs and vSphere infrastructure cleanly. Use this when you know power will not be restored. All VMs are shutdown, followed by the StarWind storage VMs, and finally the ESXi hosts themselves are shut down.

The following steps occur:
- All VMs (except vCenter and StarWind) are gracefully shut down (guest OS shutdown).
- Any remaining running VMs (except vCenter and StarWind) are then forcefully
    shut down (power off).
- vCenter is shut down.
- StarWind storage is put into maintance mode.
- ESXi hosts are shut down (which shuts down the StarWind VMs).


## Details:
The machine where APC PowerChute is installed, and where these scripts run from, *must* be a machine/host that is independent of your vSphere environment. This is required because if PowerChute and these scripts are run on a VM inside the vSphere environment, it would not be able to shutdown the environment properly because the VM itself would be shut down. An idea would be to purchase a small, low power computer (such as an Intel NUC) and run this script on it.


## Configuration:
The configuration needed to run each script is generated upon the first-run when you run the script interactively (in a powershell window). A JSON formatted configuration file is saved to the directory where this script needs to be placed/located per APC's documentation (`C:\Program Files\APC\PowerChute\user_files`). The configuration, and the script, are designed so that you should never have to modify the powershell script directly.

Note that the configuration file will include the passwords. You *should* create separate users and roles for vSphere and ESXi with minimal permissions to protect against misuse (see the scripts for the permissions required). You should also make sure the system running PowerChute, and thus this script, is hardened. It is best to run PowerChute and these scripts on a system that is non-domained joined.


## Notes:
- You will need to run this script interactively, in a powershell window, initially to create and save the configuration file. You can edit the configuration file manually after it is created.
- The configuration file generated by this script is saved to `C:\Program Files\APC\PowerChute\user_files` as that is the directory PCNS requires command files to be located in. This script must also be located in that same directory.
- There is very little error handling in this script. It is advised to heavily test this script during non-work hours to check for errors.
- You should ensure your UPS(s) have adequate runtime to allow this script to run to completion. You should also ensure your UPS(s) are configured with the proper runtime delays, wait times, etc. Setting up the UPS NMC and PCNS properly is, simply put, a pain.
- You could run this script on an Ubuntu (or other Linux OS) since powershell is available on Linux as [powershell-core](https://github.com/PowerShell/PowerShell). However, you would not have access to the StarWind Management Console (Windows application) for diagnostics during restart of your infrastructure. Plus, getting the StarWind powershell module installed is a bit of a pain (you have to export it from a Windows machine where has already been installed).
- IPs are preferred over FQDNs since your domain controllers may be running as VMs on your primary cluster and therefore would be shut down by this script possibly causing lookup issues (i.e. looking up IP of ESXi server after all VMs are shut down).


## Currently Tested/Running Configuration:
- 2-node vSphere 7U3 (ESXi and vCenter).
- StarWind vSAN 8 running on linux VMs.
- PowerChute Network Server 4.4.1.
- Dual APC UPSes, each with NMC 3.
- Windows Server 2016 as the host OS for PCNS.
- VMware PowerCLI 12.2.0 build 17538434 (component versions 12.3).


## Hardening the System Running PowerChute:
- Do not join the system running APC PowerChute to a domain.
- Set a long, complex password for the default Windows administrator user.
- Make sure Windows firewall is enabled with only the minimal ports needed for PowerChute opened.
- Make sure antivirus is working.


## Single Point of Failure:
The system running the PCNS software and these script does become a single point of failure so please take note of that in your planning. 
    - Example 1: the system could be hooked up to one of your two UPSes and that UPS has a much shorter runtime causing the script to not run to completion.
    - Example 2: the system only has one network connection and the switch the system is connected to could lose power if the UPS it is connected to dies, therefore the script would run to completion but not be able to contact vCenter, the hosts, or the StarWind VMs to perform the tasks needed.

You could potentially run redundant systems with PCNS and this script monitoring your same UPS(s) but how to handle the race condition between the two systems could become problematic (two systems issuing the same commands to vCenter, the hosts, etc). Also, you would have to handle times when one system only partially completed the shut down commands before it lost power.

## References:
- [StarWind vSAN](https://www.starwindsoftware.com/starwind-virtual-san)
- [StarWind Shutdown script](https://www.starwindsoftware.com/resource-library/starwind-virtual-san-gentle-shutdown-with-powerchute/) - Does not work (easily) due to usage of secure-string, doesn't allow for easy testing, doesn't have a ton of logging, and the script is pretty messy.
- [APC PowerChute](https://www.apc.com/shop/us/en/categories/power/uninterruptible-power-supply-ups-/ups-management/powerchute-network-shutdown/N-auzzn7)
- [APC Network Management Card User Guide](http://cdn.cnetcontent.com/c0/88/c08805e4-623b-4086-84f4-23077d7ca5b7.pdf)
- [APC PowerChute Install Guide](https://download.schneider-electric.com/files?p_File_Name=990-2838Q-EN.pdf&p_Doc_Ref=SPD_PMAR-9HBK44_EN&p_enDocType=User+guide)
- [APC PowerChute User Guide](https://download.schneider-electric.com/files?p_File_Name=990-4595H-EN-Standard.pdf&p_Doc_Ref=SPD_PMAR-9E5LVY_EN&p_enDocType=User+guide)
- https://www.stevejenkins.com/blog/2013/07/howto-configure-low-battery-duration-and-pcns-to-shut-down-with-an-apc-smartups/
- https://web.archive.org/web/20210727085714/https://www.stevejenkins.com/blog/2013/07/howto-configure-low-battery-duration-and-pcns-to-shut-down-with-an-apc-smartups/